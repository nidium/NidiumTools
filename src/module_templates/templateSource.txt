#include <Core/Utils.h>
#include <Binding/JSUtils.h>

#include "{classname}.h"

static void {classname}_Finalize(JSFreeOp *fop, JSObject *obj);
static bool nidium_{classname}_foobar(JSContext *cx, unsigned argc, jsval *vp);

static JSClass {classname}_class = {{
    "{classname}", JSCLASS_HAS_PRIVATE,
    JS_PropertyStub, JS_DeletePropertyStub, JS_PropertyStub, JS_StrictPropertyStub,
    JS_EnumerateStub, JS_ResolveStub, JS_ConvertStub, {classname}_Finalize,
    nullptr, nullptr, nullptr, nullptr, JSCLASS_NO_INTERNAL_MEMBERS
}};

template<>
JSClass *Nidium::Binding::JSExposer<JS{classname}>::jsclass = &{classname}_class;

static JSFunctionSpec {classname}_funcs[] = {{
    JS_FN("foobar", nidium_{classname}_foobar, 2, 0),
    JS_FS_END
}};

static void {classname}_Finalize(JSFreeOp *fop, JSObject *obj)
{{
    JS{classname} *instance = (JS{classname} *)JS_GetPrivate(obj);
    if (instance != NULL) {{
        delete instance;
    }}
}}

JS{classname}::JS{classname}(JS::HandleObject obj, JSContext *cx) :
    Nidium::Binding::JSExposer<JS{classname}>(obj, cx)
{{

}}

JS{classname}::~JS{classname}()
{{

}}

static bool nidium_{classname}_foobar(JSContext *cx, unsigned argc, jsval *vp)
{{

    NIDIUM_JS_PROLOGUE_CLASS(JS{classname}, &{classname}_class);

    NIDIUM_JS_CHECK_ARGS("foobar", 1);
    /* CppObj == instance of JS{classname} */

    return true;
}}

static bool nidium_{classname}_constructor(JSContext *cx,
    unsigned argc, jsval *vp)
{{
    JS::CallArgs args = JS::CallArgsFromVp(argc, vp);
    JS::RootedString foobar(cx);

    if (!args.isConstructing()) {{
        JS_ReportError(cx, "Bad constructor");
        return false;
    }}

    if (!JS_ConvertArguments(cx, args, "S", foobar.address())) {{
        return false;
    }}

    JS::RootedObject ret(cx, JS_NewObjectForConstructor(cx,
                            &{classname}_class, args));

    JS{classname} *js{classname};

    js{classname} = new JS{classname}(ret, cx);

    NidiumJSObj(cx)->GetObject(cx)->rootObjectUntilShutdown(ret);

    JS_SetPrivate(ret, js{classname});
    args.rval().setObject(*ret);

    return true;
}}

static bool registerCallback(JSContext *cx, JS::HandleObject exports) {{

    JS_InitClass(cx, exports, JS::NullPtr(), &{classname}_class,
                nidium_{classname}_constructor,
                1, NULL, {classname}_funcs, NULL, NULL);
  
    return true;
}}

NIDIUM_JS_REGISTER_MODULE(registerCallback)
